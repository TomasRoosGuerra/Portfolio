<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin: Tomas Roos Portfolio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/styles.css" />

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        doc,
        updateDoc,
        deleteDoc,
      } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

      // Your Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyBilQwP9N6kCw1IsxnDDkvkEj7HUsLTtAE",
        authDomain: "portfolio-7ba48.firebaseapp.com",
        projectId: "portfolio-7ba48",
        storageBucket: "portfolio-7ba48.firebasestorage.app",
        messagingSenderId: "1022085096489",
        appId: "1:1022085096489:web:9182270ab64bd18aba2838",
        measurementId: "G-ELZZ0CREEN",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const provider = new GoogleAuthProvider();

      // Admin functionality
      class AdminPanel {
        constructor() {
          this.currentUser = null;
          this.projects = [];
          this.init();
        }

        async init() {
          this.setupAuth();
          this.setupEventListeners();
          await this.loadProjects();
        }

        setupAuth() {
          onAuthStateChanged(auth, (user) => {
            this.currentUser = user;
            this.updateUI();
          });
        }

        async signIn() {
          try {
            console.log("Attempting to sign in...");
            console.log("Auth domain:", firebaseConfig.authDomain);
            console.log("Project ID:", firebaseConfig.projectId);

            const result = await signInWithPopup(auth, provider);
            console.log("Sign in successful:", result.user.email);
          } catch (error) {
            console.error("Sign in error:", error);
            console.error("Error code:", error.code);
            console.error("Error message:", error.message);

            let errorMessage = "Sign in failed. ";

            switch (error.code) {
              case "auth/popup-closed-by-user":
                errorMessage += "Sign-in popup was closed.";
                break;
              case "auth/popup-blocked":
                errorMessage +=
                  "Popup was blocked by browser. Please allow popups.";
                break;
              case "auth/unauthorized-domain":
                errorMessage +=
                  "This domain is not authorized. Check Firebase console.";
                break;
              case "auth/operation-not-allowed":
                errorMessage +=
                  "Google sign-in is not enabled. Check Firebase console.";
                break;
              case "auth/network-request-failed":
                errorMessage +=
                  "Network error. Check your internet connection.";
                break;
              default:
                errorMessage += `Error: ${error.message}`;
            }

            alert(errorMessage);
          }
        }

        async signOut() {
          try {
            await signOut(auth);
          } catch (error) {
            console.error("Sign out error:", error);
          }
        }

        updateUI() {
          const authSection = document.getElementById("auth-section");
          const adminSection = document.getElementById("admin-section");

          if (this.currentUser) {
            authSection.style.display = "none";
            adminSection.style.display = "block";
            document.getElementById("user-email").textContent =
              this.currentUser.email;
          } else {
            authSection.style.display = "block";
            adminSection.style.display = "none";
          }
        }

        setupEventListeners() {
          document
            .getElementById("sign-in-btn")
            .addEventListener("click", () => this.signIn());
          document
            .getElementById("test-firebase-btn")
            .addEventListener("click", () => this.testFirebaseConnection());
          document
            .getElementById("sign-out-btn")
            .addEventListener("click", () => this.signOut());
          document
            .getElementById("add-project-form")
            .addEventListener("submit", (e) => this.handleAddProject(e));
          document
            .getElementById("image-upload")
            .addEventListener("change", (e) => this.handleImageUpload(e));
        }

        async testFirebaseConnection() {
          try {
            console.log("Testing Firebase connection...");
            console.log("Firebase config:", firebaseConfig);

            // Test Firestore connection
            const testCollection = collection(db, "test");
            console.log("Firestore collection created successfully");

            // Test Auth
            console.log("Auth instance:", auth);
            console.log("Auth domain:", auth.config.authDomain);

            alert("Firebase connection successful! Check console for details.");
          } catch (error) {
            console.error("Firebase connection test failed:", error);
            alert(`Firebase connection failed: ${error.message}`);
          }
        }

        async loadProjects() {
          try {
            const querySnapshot = await getDocs(collection(db, "projects"));
            this.projects = [];
            querySnapshot.forEach((doc) => {
              this.projects.push({ id: doc.id, ...doc.data() });
            });
            this.renderProjects();
          } catch (error) {
            console.error("Error loading projects:", error);
          }
        }

        renderProjects() {
          const container = document.getElementById("projects-list");
          container.innerHTML = "";

          this.projects.forEach((project) => {
            const projectEl = document.createElement("div");
            projectEl.className = "project-item";
            projectEl.innerHTML = `
            <div class="project-preview">
              <img src="${project.imageUrl}" alt="${project.title}" />
              <div class="project-info">
                <h3>${project.title}</h3>
                <p>${project.description}</p>
                <div class="project-meta">
                  <span class="category">${project.category}</span>
                  <span class="date">${new Date(
                    project.createdAt
                  ).toLocaleDateString()}</span>
                </div>
              </div>
            </div>
            <div class="project-actions">
              <button onclick="adminPanel.editProject('${
                project.id
              }')" class="btn btn--ghost">Edit</button>
              <button onclick="adminPanel.deleteProject('${
                project.id
              }')" class="btn btn--primary">Delete</button>
            </div>
          `;
            container.appendChild(projectEl);
          });
        }

        async handleImageUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          // For now, we'll use a placeholder. In production, you'd upload to Firebase Storage
          const reader = new FileReader();
          reader.onload = (e) => {
            document.getElementById("image-preview").src = e.target.result;
            document.getElementById("image-preview").style.display = "block";
          };
          reader.readAsDataURL(file);
        }

        async handleAddProject(event) {
          event.preventDefault();

          const formData = new FormData(event.target);
          const projectData = {
            title: formData.get("title"),
            description: formData.get("description"),
            category: formData.get("category"),
            imageUrl: document.getElementById("image-preview").src || "",
            createdAt: new Date().toISOString(),
            published: formData.get("published") === "on",
          };

          try {
            await addDoc(collection(db, "projects"), projectData);
            await this.loadProjects();
            event.target.reset();
            document.getElementById("image-preview").style.display = "none";
            alert("Project added successfully!");
          } catch (error) {
            console.error("Error adding project:", error);
            alert("Failed to add project. Please try again.");
          }
        }

        async deleteProject(projectId) {
          if (!confirm("Are you sure you want to delete this project?")) return;

          try {
            await deleteDoc(doc(db, "projects", projectId));
            await this.loadProjects();
            alert("Project deleted successfully!");
          } catch (error) {
            console.error("Error deleting project:", error);
            alert("Failed to delete project. Please try again.");
          }
        }

        editProject(projectId) {
          // Implementation for editing projects
          alert("Edit functionality coming soon!");
        }
      }

      // Initialize admin panel
      const adminPanel = new AdminPanel();
      window.adminPanel = adminPanel;
    </script>

    <style>
      body {
        background: var(--bg);
        color: var(--text);
        font-family: Inter, sans-serif;
        padding: 40px 20px;
      }

      .admin-container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .admin-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .admin-header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .admin-header p {
        color: var(--muted);
        font-size: 1.1rem;
      }

      #auth-section {
        text-align: center;
        padding: 60px 20px;
      }

      .auth-card {
        background: var(--bg-alt);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 40px;
        max-width: 400px;
        margin: 0 auto;
      }

      .auth-card h2 {
        margin-bottom: 20px;
      }

      .auth-card p {
        color: var(--muted);
        margin-bottom: 30px;
      }

      #admin-section {
        display: none;
      }

      .user-info {
        background: var(--bg-alt);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .add-project-form {
        background: var(--bg-alt);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 40px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--line);
        border-radius: 8px;
        background: var(--bg);
        color: var(--text);
        font-family: inherit;
      }

      .form-group textarea {
        min-height: 100px;
        resize: vertical;
      }

      .image-upload-area {
        border: 2px dashed var(--line);
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s ease;
      }

      .image-upload-area:hover {
        border-color: var(--accent);
      }

      .image-preview {
        max-width: 200px;
        border-radius: 8px;
        margin-top: 10px;
        display: none;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .projects-section h2 {
        margin-bottom: 20px;
      }

      .project-item {
        background: var(--bg-alt);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .project-preview {
        display: flex;
        gap: 20px;
        flex: 1;
      }

      .project-preview img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
      }

      .project-info h3 {
        margin: 0 0 8px 0;
        font-size: 1.1rem;
      }

      .project-info p {
        margin: 0 0 10px 0;
        color: var(--muted);
        font-size: 0.9rem;
      }

      .project-meta {
        display: flex;
        gap: 15px;
        font-size: 0.8rem;
      }

      .category {
        background: var(--accent);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
      }

      .project-actions {
        display: flex;
        gap: 10px;
      }

      .btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: 1px solid var(--line);
        background: var(--bg);
        color: var(--text);
        text-decoration: none;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
      }

      .btn:hover {
        background: var(--bg-alt);
      }

      .btn--primary {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .btn--primary:hover {
        background: var(--brand-ink);
      }

      .btn--ghost {
        background: transparent;
      }

      .btn--ghost:hover {
        background: var(--bg-alt);
      }
    </style>
  </head>
  <body>
    <div class="admin-container">
      <div class="admin-header">
        <h1>Portfolio Admin</h1>
        <p>Manage your projects and content</p>
      </div>

      <!-- Authentication Section -->
      <div id="auth-section">
        <div class="auth-card">
          <h2>Sign In Required</h2>
          <p>
            Please sign in with your Gmail account to access the admin panel.
          </p>
          <button
            id="test-firebase-btn"
            class="btn btn--ghost"
            style="margin-bottom: 10px"
          >
            Test Firebase Connection
          </button>
          <br />
          <button id="sign-in-btn" class="btn btn--primary">
            Sign in with Google
          </button>
        </div>
      </div>

      <!-- Admin Section -->
      <div id="admin-section">
        <div class="user-info">
          <div>
            <strong>Signed in as:</strong> <span id="user-email"></span>
          </div>
          <button id="sign-out-btn" class="btn btn--ghost">Sign Out</button>
        </div>

        <!-- Add Project Form -->
        <form id="add-project-form" class="add-project-form">
          <h2>Add New Project</h2>

          <div class="form-group">
            <label for="title">Project Title</label>
            <input type="text" id="title" name="title" required />
          </div>

          <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" required></textarea>
          </div>

          <div class="form-group">
            <label for="category">Category</label>
            <select id="category" name="category" required>
              <option value="">Select a category</option>
              <option value="web-design">Web Design</option>
              <option value="mobile-app">Mobile App</option>
              <option value="ui-ux">UI/UX</option>
              <option value="branding">Branding</option>
              <option value="illustration">Illustration</option>
            </select>
          </div>

          <div class="form-group">
            <label for="image-upload">Project Image</label>
            <div
              class="image-upload-area"
              onclick="document.getElementById('image-upload').click()"
            >
              <p>Click to upload image</p>
              <input
                type="file"
                id="image-upload"
                accept="image/*"
                style="display: none"
              />
              <img id="image-preview" class="image-preview" />
            </div>
          </div>

          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="published" name="published" />
              <label for="published">Publish immediately</label>
            </div>
          </div>

          <button type="submit" class="btn btn--primary">Add Project</button>
        </form>

        <!-- Projects List -->
        <div class="projects-section">
          <h2>Existing Projects</h2>
          <div id="projects-list"></div>
        </div>
      </div>
    </div>
  </body>
</html>
